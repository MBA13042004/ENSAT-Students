name: Docker Build & Push

on:
  push:
    branches: [ "main" ]

jobs:
  # Job 1: Simple Verification (No bugs!)
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, json
          coverage: none

      - name: ğŸ¼ Install Dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: ğŸ“ Simple Key Gen
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: âœ… Test 1 - Composer Valid?
        run: composer validate --strict

      - name: âœ… Test 2 - App Boots?
        run: php artisan --version

  # Job 2: Build & Push
  build-and-push:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ³ Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ensat-students:latest

      # Notification Step at the end
      - name: ğŸ”” Notification
        if: success()
        run: |
          echo "::notice title=Deployment Status::âœ… CI/CD TerminÃ© avec succÃ¨s ! L'image est sur Docker Hub."
          # Pour activer une vraie notification Discord/Slack, dÃ©commentez ci-dessous :
          # - uses: rjstone/discord-webhook-notify@v1
          #   with:
          #      severity: info
          #      username: GitHub Actions
          #      description: Le dÃ©ploiement a rÃ©ussi !
          #      webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}

version: '3.8'

services:
  # PHP-FPM Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ensat_app
    restart: unless-stopped
    working_dir: /var/www/html
    environment:
      - APP_NAME=ENSAT Students
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=http://localhost:8080
      # Generate with: php artisan key:generate --show
      # Or use a pre-generated key for production
      - APP_KEY=base64:MGIfbFY3MaZPFKv24z5D6EOkSzjrGGabhiqOJmhFZs0=

      # Database Configuration
      - DB_CONNECTION=mysql
      - DB_HOST=db
      - DB_PORT=3306
      - DB_DATABASE=ensat_students
      - DB_USERNAME=ensat_user
      - DB_PASSWORD=ensat_secure_password_2026

      # Laravel Configuration
      - SESSION_DRIVER=database
      - CACHE_STORE=database
      - QUEUE_CONNECTION=database

      # Firebase Configuration (update with your values)
      - FIREBASE_PROJECT_ID=ensat-students-ceb18
      - FIREBASE_CREDENTIALS=/var/www/html/storage/app/firebase/serviceAccountKey.json
      - ADMIN_EMAIL=admin@ensat.ma

      # Firebase Frontend (update with your values)
      - VITE_FIREBASE_API_KEY=AIzaSyA-i0w8f7q9DlOZTtqs3jEHIlDIewConJw
      - VITE_FIREBASE_AUTH_DOMAIN=ensat-students-ceb18.firebaseapp.com
      - VITE_FIREBASE_PROJECT_ID=ensat-students-ceb18

      # Mail
      - MAIL_MAILER=log

    volumes:
      - ./storage:/var/www/html/storage
      - /var/www/html/bootstrap/cache
      - public_data:/var/www/html/public
      # Optional: Mount Firebase credentials
      # - ./storage/app/firebase/serviceAccountKey.json:/var/www/html/storage/app/firebase/serviceAccountKey.json:ro
    depends_on:
      db:
        condition: service_healthy
    networks:
      - backend

  # Nginx Web Server
  webserver:
    image: nginx:alpine
    container_name: ensat_webserver
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - public_data:/var/www/html/public:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - app
    networks:
      - frontend
      - backend

  # MySQL Database
  db:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password
    container_name: ensat_db
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=ensat_students
      - MYSQL_USER=ensat_user
      - MYSQL_PASSWORD=ensat_secure_password_2026
      - MYSQL_ROOT_PASSWORD=root_secure_password_2026
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3307:3306"
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "ensat_user", "-pensat_secure_password_2026" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - backend

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge

volumes:
  mysql_data:
  public_data:
    driver: local
